<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensitive Data Protector - Privacy Gateway Demo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Sensitive Data Protector</h1>
            <p class="subtitle">Privacy Gateway Demo - Regex Edition</p>
            <p class="description">Fast PII masking before sending to AI APIs</p>
        </header>

        <!-- Status Indicators -->
        <div class="status-bar">
            <div class="status-item {{ 'active' if openai_available else 'inactive' }}">
                <span class="status-dot"></span>
                <span>OpenAI API</span>
            </div>
            <div class="status-item active">
                <span class="status-dot"></span>
                <span>Regex PII Detection</span>
            </div>
        </div>

        <!-- Input Section -->
        <section class="step-section input-section">
            <div class="step-header">
                <span class="step-number">INPUT</span>
                <h2>Enter Text with Sensitive Data</h2>
            </div>
            <div class="step-content">
                <textarea id="userInput" placeholder="Enter text containing sensitive information...">Hi, my name is John Smith and I need help with my account.
My credit card number is 4532-1234-5678-9012 and my SSN is 123-45-6789.
You can reach me at john.smith@email.com or call me at (555) 123-4567.
Please review my recent transactions and provide spending advice.</textarea>
                
                <div class="method-badge">
                    <span class="badge-icon">‚ö°</span>
                    <span>Using fast regex-based PII detection</span>
                </div>
                
                <button id="processBtn" class="btn-primary">
                    <span class="btn-icon">üîí</span>
                    Process & Protect Data
                </button>
            </div>
        </section>

        <!-- Results Container -->
        <div id="results" class="results-container hidden">
            
            <!-- Step 1: PII Detection -->
            <section class="step-section detection-section">
                <div class="step-header">
                    <span class="step-number">STEP 1</span>
                    <h2>üîç PII Detection</h2>
                    <span class="step-badge local">Regex Patterns</span>
                </div>
                <div class="step-content">
                    <p class="step-description">Sensitive data identified using pattern matching:</p>
                    <div id="detectedPII" class="pii-grid"></div>
                </div>
            </section>

            <!-- Step 2: Masking -->
            <section class="step-section masking-section">
                <div class="step-header">
                    <span class="step-number">STEP 2</span>
                    <h2>üé≠ Data Masking</h2>
                    <span class="step-badge local">Processed Locally</span>
                </div>
                <div class="step-content">
                    <div class="comparison">
                        <div class="comparison-side original">
                            <h3>üî¥ Original (Contains PII)</h3>
                            <div id="originalText" class="text-box danger"></div>
                        </div>
                        <div class="comparison-arrow">‚Üí</div>
                        <div class="comparison-side masked">
                            <h3>üü¢ Masked (Safe to Send)</h3>
                            <div id="maskedText" class="text-box safe"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 3: Mapping -->
            <section class="step-section mapping-section">
                <div class="step-header">
                    <span class="step-number">STEP 3</span>
                    <h2>üó∫Ô∏è PII Mapping</h2>
                    <span class="step-badge local">Stored Locally Only</span>
                </div>
                <div class="step-content">
                    <p class="step-description">This mapping never leaves your machine:</p>
                    <div id="mappingTable" class="mapping-table"></div>
                </div>
            </section>

            <!-- Step 4: AI Response -->
            <section class="step-section ai-section">
                <div class="step-header">
                    <span class="step-number">STEP 4</span>
                    <h2>ü§ñ AI Response</h2>
                    <span class="step-badge cloud">OpenAI API</span>
                </div>
                <div class="step-content">
                    <p class="step-description">OpenAI only sees placeholders, not your real data:</p>
                    <div id="aiResponseMasked" class="text-box ai-response"></div>
                </div>
            </section>

            <!-- Step 5: Unmasking -->
            <section class="step-section final-section">
                <div class="step-header">
                    <span class="step-number">STEP 5</span>
                    <h2>‚ú® Final Response</h2>
                    <span class="step-badge local">Unmasked Locally</span>
                </div>
                <div class="step-content">
                    <p class="step-description">Response restored with your original data:</p>
                    <div id="aiResponseFinal" class="text-box final-response"></div>
                </div>
            </section>

            <!-- Summary -->
            <section class="step-section summary-section">
                <div class="step-header">
                    <span class="step-number">SUMMARY</span>
                    <h2>üìä Privacy Protection Results</h2>
                </div>
                <div class="step-content">
                    <div class="summary-grid">
                        <div class="summary-card local-card">
                            <h3>üè† Stayed Local</h3>
                            <ul id="localList">
                                <li>Your actual PII data</li>
                                <li>The mapping dictionary</li>
                                <li>PII detection (regex)</li>
                                <li>Final unmasking</li>
                            </ul>
                        </div>
                        <div class="summary-card cloud-card">
                            <h3>‚òÅÔ∏è Sent to OpenAI</h3>
                            <ul>
                                <li>Anonymized prompt only</li>
                                <li>Generic placeholders</li>
                                <li>No real PII exposed</li>
                            </ul>
                        </div>
                    </div>
                    <div class="success-message">
                        <span class="success-icon">üîí</span>
                        <span>Your sensitive data was protected! OpenAI never saw your real information.</span>
                    </div>
                </div>
            </section>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="loading-overlay hidden">
            <div class="loading-content">
                <div class="spinner"></div>
                <p>Calling OpenAI API...</p>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message hidden"></div>

        <footer>
            <p>Sensitive Data Protector | Privacy-First AI Architecture</p>
            <p class="footer-link">Learn more at <a href="#">Code to Cognition Blog</a></p>
        </footer>
    </div>

    <script>
        const processBtn = document.getElementById('processBtn');
        const userInput = document.getElementById('userInput');
        const results = document.getElementById('results');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');

        processBtn.addEventListener('click', async () => {
            const input = userInput.value.trim();
            if (!input) {
                showError('Please enter some text to process.');
                return;
            }

            // Show loading
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            errorMessage.classList.add('hidden');

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: input })
                });

                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }

                displayResults(data);
            } catch (err) {
                showError('Failed to process: ' + err.message);
            } finally {
                loading.classList.add('hidden');
            }
        });

        function displayResults(data) {
            // Step 1: Detected PII
            const piiGrid = document.getElementById('detectedPII');
            piiGrid.innerHTML = data.detected_pii.map(pii => `
                <div class="pii-item">
                    <span class="pii-type">${pii.type}</span>
                    <span class="pii-value">${escapeHtml(pii.value)}</span>
                </div>
            `).join('') || '<p class="no-pii">No PII detected</p>';

            // Step 2: Original vs Masked
            document.getElementById('originalText').innerHTML = highlightPII(
                escapeHtml(data.original_input), 
                data.detected_pii
            );
            document.getElementById('maskedText').innerHTML = highlightPlaceholders(
                escapeHtml(data.masked_input)
            );

            // Step 3: Mapping Table
            const mappingTable = document.getElementById('mappingTable');
            const mappingEntries = Object.entries(data.mapping);
            mappingTable.innerHTML = mappingEntries.map(([placeholder, value]) => `
                <div class="mapping-row">
                    <span class="mapping-placeholder">${escapeHtml(placeholder)}</span>
                    <span class="mapping-arrow">‚Üí</span>
                    <span class="mapping-value">${escapeHtml(value)}</span>
                </div>
            `).join('') || '<p>No mappings</p>';

            // Step 4: AI Response (masked)
            document.getElementById('aiResponseMasked').innerHTML = highlightPlaceholders(
                escapeHtml(data.ai_response_masked || 'No AI response')
            );

            // Step 5: Final Response
            document.getElementById('aiResponseFinal').innerHTML = highlightPII(
                escapeHtml(data.ai_response_unmasked || 'No AI response'),
                data.detected_pii
            );

            // Update summary
            document.getElementById('localList').innerHTML = `
                <li>‚úÖ ${data.detected_pii.length} PII items protected</li>
                <li>‚úÖ ${mappingEntries.length} mappings stored locally</li>
                <li>‚úÖ PII detection (regex)</li>
                <li>‚úÖ Final unmasking</li>
            `;

            // Show results
            results.classList.remove('hidden');
            results.scrollIntoView({ behavior: 'smooth' });
        }

        function highlightPII(text, piiList) {
            let result = text;
            piiList.forEach(pii => {
                const escaped = escapeRegex(pii.value);
                result = result.replace(
                    new RegExp(escaped, 'g'),
                    `<mark class="highlight-pii">${escapeHtml(pii.value)}</mark>`
                );
            });
            return result;
        }

        function highlightPlaceholders(text) {
            return text.replace(
                /\[([A-Z_]+_\d+)\]/g,
                '<mark class="highlight-placeholder">[$1]</mark>'
            );
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            loading.classList.add('hidden');
        }
    </script>

    <style>
        .method-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #f59e0b;
        }
        .badge-icon {
            font-size: 1.25rem;
        }
    </style>
</body>
</html>
